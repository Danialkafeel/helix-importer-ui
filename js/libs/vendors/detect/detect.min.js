// Adobe Corp. internal project "webpage-blueprint-detector" - Author: catalan@adobe.com
(()=>{{let s=o=>{typeof o[0]=="string"&&!o[0].startsWith("[detect]")&&(o[0]=`[detect] ${o[0]}`)},e=console.log;console.log=(...o)=>{s(o),e(...o)},console.debug=(...o)=>{window.DEBUG&&(s(o),e(...o))};let n=console.warn;console.warn=(...o)=>{s(o),n(...o)};let t=console.error;console.error=(...o)=>{s(o),t(...o)}}function C(s){return s.toString(16)}function N(s,e,n,t){return C(s)+C(e)+C(n)+C(t)}var y=class s{constructor({r:e,g:n,b:t,a:o=1,name:r=""}){this.name=r,this.r=e,this.g=n,this.b=t,this.a=o}toHex(){return N(this.r,this.g,this.b,this.a)}static fromRGBA(e){let n=e.replace("rgba(","").replace(")","").split(",").map(t=>parseInt(t.trim()));return new s({r:n[0],g:n[1],b:n[2],a:n[3]})}toRGBA(){return`rgba(${this.r}, ${this.g}, ${this.b}, ${this.a})`}withAlpha(e){return new s({...this,a:e})}static random(e=!1){let n=Math.round(Math.random()*255),t=Math.round(Math.random()*255),o=Math.round(Math.random()*255),r=e?Math.random():1;return new s({name:`rand-${n}-${t}-${o}-${r}`,r:n,g:t,b:o,a:r})}static fromHex(e){let n=parseInt(e.substring(0,2),16),t=parseInt(e.substring(2,4),16),o=parseInt(e.substring(4,6),16),r=parseInt(e.substring(6,8),16);return new s({name:`hex-${n}-${t}-${o}-${r}`,r:n,g:t,b:o,a:r})}};function L(s,e){let n=Math.max(0,Math.min(s.x+s.width,e.x+e.width)-Math.max(s.x,e.x)),t=Math.max(0,Math.min(s.y+s.height,e.y+e.height)-Math.max(s.y,e.y)),o=n*t,r=e.width*e.height;return o/r*100}function O(s,e){let n=s.getBoundingClientRect();return{left:n.left+e.document.scrollingElement.scrollLeft,top:n.top+e.document.scrollingElement.scrollTop}}var S=class s{constructor(e,n,t,o,r){this.id=crypto.randomUUID(),this.x=Math.floor(e),this.y=Math.floor(n),this.width=Math.floor(t),this.height=Math.floor(o),this.div=r,this.children=[],this.prediction=null,this.layout=null}static fromDiv(e,n){let t=e.getBoundingClientRect(),o=O(e,n);return new s(o.left,o.top,t.width,t.height,e)}static areBoxesLaidOutAsGrid(e){console.log("areBoxesLaidOutAsGrid");try{if(e.length<2)return!1;let n=e.slice().sort((i,a)=>i.x-a.x||i.y-a.y),t=e.slice().sort((i,a)=>i.y-a.y||i.x-a.x);console.log(n),console.log(t);let o=[];for(let i=1;i<n.length;i++)o.push(n[i].x-n[i-1].x);if([...new Set(o)].length>1)return!1;let l=[];for(let i=1;i<t.length;i++)l.push(t[i].y-t[i-1].y);return!([...new Set(l)].length>1)}finally{return!0}}contains(e,n=!0){return n?e.x-e.width>=this.x-this.width&&e.x+e.width<=this.x+this.width&&e.y-e.height>=this.y-this.height&&e.y+e.height<=this.y+this.height:L(this,e)>75}intersects(e){return!(e.x-e.width>this.x+this.width||e.x+e.width<this.x-this.width||e.y-e.height>this.y+this.height||e.y+e.height<this.y-this.height)}isInside(e){return e.x-e.width<=this.x-this.width&&e.x+e.width>=this.x+this.width&&e.y-e.height<=this.y-this.height&&e.y+e.height>=this.y+this.height}addChild(e){this.children.push(e)}isChild(e){return this.children.some(this.isChild)}determineLayout(){return this.layout={numCols:M(this.children),numRows:R(this.children)},this.layout}};function M(s){if(!s.length)return 0;s.sort((n,t)=>n.x-t.x);let e=[];return s.forEach(n=>{let t=n.x,o=n.x+n.width,r=e[e.length-1];r?t>=r-5&&e.push(o):e.push(o)}),console.log(e),e.length}function R(s){if(console.log(s),!s.length)return 0;s.sort((n,t)=>n.y-t.y);let e=[];return s.forEach(n=>{let t=n.y,o=n.y+n.height,r=e[e.length-1];r?t>=r-5&&e.push(o):e.push(o)}),console.log(e),e.length}var f=class s{static getXPath(e,n,t=!1){for(var o=n.getElementsByTagName("*"),r=[];e&&e.nodeType==1;e=e.parentNode)if(t)if(e.hasAttribute("id")){for(var l=0,c=0;c<o.length&&(o[c].hasAttribute("id")&&o[c].id==e.id&&l++,!(l>1));c++);if(l==1)return r.unshift('id("'+e.getAttribute("id")+'")'),r.join("/");r.unshift(e.localName.toLowerCase()+'[@id="'+e.getAttribute("id")+'"]')}else e.hasAttribute("class")&&r.unshift(e.localName.toLowerCase()+'[@class="'+[...e.classList].join(" ").trim()+'"]');else{for(var i=1,a=e.previousSibling;a;a=a.previousSibling)a.localName==e.localName&&(i+=1);r.unshift(e.localName.toLowerCase()+"["+i+"]")}return r.length?"/"+r.join("/"):null}static isVisible(e,n){if(!e)return!1;if(e.nodeType===n.Node.DOCUMENT_NODE)return!0;if(e.nodeType===n.Node.ELEMENT_NODE){let t=n.getComputedStyle(e);return t.display.includes("none")||t.visibility.includes("hidden")||t.opacity==="0"?!1:s.isVisible(e.parentNode,n)}}static isUserVisible(e,n){if(!s.isVisible(e,n))return!1;let t=e.getBoundingClientRect(),{width:o,height:r}=s.getPageSize(n.document);return!(t.height===0||t.width===0)}static getNSiblingsDivs(e,n,t=null){let o=t;isNaN(t)||(o=c=>c===t);let r="",l=[];e.querySelectorAll("div").forEach(c=>{let i=s.getXPath(c,n),a=i.substring(0,i.lastIndexOf("["));l[a]?l[a].push(c):l[a]=[c]});for(let c in l)if(o(l[c].length)){r=c;break}return l[r]||null}static getPageSize(e){var n=e.documentElement,t=e.body,o=Math.max(n.clientWidth,n.scrollWidth,n.offsetWidth,t.scrollWidth,t.offsetWidth),r=Math.max(n.clientHeight,n.scrollHeight,n.offsetHeight,t.scrollHeight,t.offsetHeight);return{width:o,height:r}}static getOffsetRect(e,n){let t=e.getBoundingClientRect(),o=n.document?.scrollingElement?.scrollLeft||0,r=n.document?.scrollingElement?.scrollTop||0;return{x:t.left+o,y:t.top+r,width:t.width,height:t.height}}static checkElStackUpCSSClasses(e,n){let t=e;for(;t;){if(t.classList.contains(n))return!0;t=t.parentElement}return!1}static getAllVisibleElements=(e=document.body,n)=>{let t=[...e.querySelectorAll("*")].filter(l=>!["IFRAME","NOSCRIPT","BR","EM","STRONG","STYLE","SCRIPT"].includes(l.nodeName)).reduce((l,c,i)=>{var a=c.closest("svg");return!(a!==null&&a!==c)&&!l.includes(c.nodeName)&&l.push(c.nodeName),l},[]);console.debug("DOM node types:",t);let r=[...e.querySelectorAll(t.join(","))].filter(l=>s.isUserVisible(l,n));return console.log(`found ${r.length} visible elements in the page.`),r}};var b=class{constructor(...e){e.reduce((n,t,o)=>(n[t]=1<<o,n),this)}},w=class{#e=0;constructor(...e){this.#e=0,this.setFlags(...e)}get flag(){return this.#e}setFlags(...e){this.#e=e.reduce((n,t)=>n|t,0)}setFlag(e){this.#e|=e}unsetFlag(e){this.#e&=~e}isFlagSet(e){return(this.#e&e)!==0}areOnlyFlagsSet(...e){let n=e.reduce((t,o)=>t|o,0);return this.#e===n}getFlags(e){return Object.keys(e).filter(n=>this.isFlagSet(e[n]))}};function E(s){var e=0,n=s.length,t=0;if(n>0)for(;t<n;)e=(e<<5)-e+s.charCodeAt(t++)|0;return e}function A(s,...e){return(...n)=>{let t=n[n.length-1]||{},o=[s[0]];return e.forEach((r,l)=>{let c=Number.isInteger(r)?n[r]:t[r];o.push(c,s[l+1])}),o.join("")}}function I(s,e){let n=null,t=null;return n=[...s.querySelectorAll("*")].some(o=>{let r=e.getComputedStyle(o),l=o.getBoundingClientRect(),c=r.backgroundImage||"none",i="none";if(i&&i.includes("rgba")&&Color.fromRGBA(i).a===0&&(i="none"),c.includes("none")&&i.includes("none"))return!1;if(c||i)return t=o,!0}),n||(n=[...s.querySelectorAll("img")].some(o=>f.isUserVisible(o,e)),n)?t:n}var d=window.xp??{},T=class{constructor({sectionType:e,sectionFeatures:n,template:t,confidence:o}){this.sectionType=e,this.sectionFeatures=n,this.template=t,this.confidence=o}},D=[{name:"carousel",predictFn:(s,e,n,t,o)=>{console.log(s.div),console.groupCollapsed(">>> carousel");let r=f.getNSiblingsDivs(s.div,o.document,l=>l>=2);if(r){console.log("predict carousel"),console.log(r);let l={};r.forEach(i=>{let a=f.getXPath(i,o.document),h=[...i.querySelectorAll("div")].map(x=>f.getXPath(x,o.document).slice(a.length));console.log(h);let u=E(h.join(`
`));console.log(u),l[u]?l[u].push(i):l[u]=[i]}),console.groupEnd();let c=Object.keys(l).filter(i=>l[i].length>1);if(l[c]){let i=!1,a=!1;if(l[c].forEach(h=>{let u=h.getBoundingClientRect();!f.isVisible(h,o)||u.x+u.width>o.innerWidth?a=!0:i=!0}),i&&a)return!0}return!1}return console.groupEnd(),!1}},{name:"columns",predictFn:(s,e,n,t,o)=>t.isFlagSet(g.isGridLayout)},{name:"hero",predictFn:(s,e,n,t,o)=>s.height<=o.innerHeight&&t.isFlagSet(g.hasBackground)&&t.isFlagSet(g.hasHeading)&&t.isFlagSet(g.hasCTA)},{name:"default-content",predictFn:(s,e,n,t,o)=>{let r=!0;[...s.div.querySelectorAll("img")].some(i=>{let a=i.getBoundingClientRect();return a.width>50&&a.height>50})&&(r=!1);let c=!s.children.some(i=>(console.log(i.prediction?.sectionType),!["heading","text","text+icons"].includes(i.prediction?.sectionType)));return console.log("childrenOnlyTextLike",c),t.isFlagSet(g.hasTexts)&&!t.isFlagSet(g.hasImages)&&!t.isFlagSet(g.hasBackground)||!t.isFlagSet(g.isGridLayout)&&c&&t.isFlagSet(g.hasTexts)&&r&&!t.isFlagSet(g.hasBackground)}}];d.DOM=f;d.Flags=b;d.FlagSet=w;function P(s,e){let n=e.document.createElement("a");document.body.appendChild(n);let t=e.getComputedStyle(n);return[...s.querySelectorAll("a")].find(r=>{if(["background","background-color","background-image"].find(i=>{let a=e.getComputedStyle(r);return console.log(i,a[i],t[i]),a[i]!==t[i]}))return console.log("hasBackground"),!0;let c=0;return["left","right","top","bottom"].forEach(i=>{let a=e.getComputedStyle(r).getPropertyValue(`border-${i}-style`);console.log(i,a,t[`border-${i}-style`]),a!==t[`border-${i}-style`]&&c++}),c>1?(console.log("bordersNum"),!0):!1})!==void 0}var q=[new y({name:"violet",r:148,g:0,b:211}),new y({name:"indigo",r:75,g:0,b:130}),new y({name:"blue",r:0,g:0,b:255}),new y({name:"green",r:0,g:255,b:0}),new y({name:"yellow",r:255,g:255,b:0}),new y({name:"orange",r:255,g:127,b:0}),new y({name:"red",r:255,g:0,b:0})];d.filterDivs=s=>{let e=s.filter(t=>{let o=t.getBoundingClientRect(),{width:r,height:l}=f.getPageSize();return!t.classList.contains("xp-ui")&&!t.closest(".xp-ui")&&o.width!==0&&o.height!==0&&o.width*o.height>1e4&&o.width*o.height<.8*r*l&&f.isVisible(t,window)});console.log(e.length),console.log(e.map(t=>t));let n=e.filter(t=>{let o=t.parentElement;for(;o;){let r=t.getBoundingClientRect(),l=o.getBoundingClientRect();if(l.width===0||l.height===0){o=o.parentElement;continue}if(r.width>=.9*l.width&&r.height>=.9*l.height)return!1;o=o.parentElement}return!0});return console.log(n.length),console.log(n.map(t=>t)),n};var $=A`position:absolute;z-index:999999;left:${0}px;top:${1}px;width:${2}px;height:${3}px;border:2px solid ${4};`,k=(s,{window:e,target:n=document.body,padding:t=0,color:o=null,label:r=null})=>{let l=o||"rgba(0, 0, 255, 1)",c=f.getOffsetRect(s.div,e),i=document.createElement("div");if(i.dataset.boxId=s.id,i.dataset.boxXpath=s.xpath,i.dataset.boxData=JSON.stringify((({id:a,x:h,y:u,width:x,height:p,xpath:v,layout:m})=>({id:a,x:h,y:u,width:x,height:p,xpath:v,layout:m}))(s)),i.className="xp-overlay",i.style=$(c.x+t,c.y+t,c.width-t*2-4,c.height-t*2-4,l),r){let a=e.document.createElement("div");a.className="xp-overlay-label",a.textContent=r,i.appendChild(a)}n.appendChild(i)};function B(s,e,n=0,t=q,o=null,r=0){s.forEach((l,c)=>{let i=o||t[c%(t.length-1)],a=r===0?1:Math.max(.1,.5-r*.1),h=i.withAlpha(a).toRGBA();l.color=h,k(l,{window:e,target:e.document.body,padding:n,color:h}),l.children.length>0&&B(l.children,e,n+2,t,i,r+1)})}var g=new b("isFromRootBox","hasHeader","hasTexts","hasBackground","hasHeading","hasCTA","hasImages","hasMultipleColumns","hasMultipleRows","isGridLayout","isInsideAHeaderLikeElement","isInsideAFooterLikeElement");function F(s,e,n=null,t,o=!0){if(s.ignored)return null;let r="unknown",l=new w,c=s.div;if(o&&l.setFlag(g.isFromRootBox),c){let a=c.cloneNode(!0);a.querySelectorAll("script, style, link, meta, noscript").forEach(H=>H.remove()),a.textContent.replaceAll(" ","").replaceAll(`
`,"").trim().length>0&&l.setFlag(g.hasTexts),([...c.querySelectorAll("img, picture, svg")].length>0||["IMG","PICTURE","SVG"].includes(c.nodeName))&&l.setFlag(g.hasImages),!!I(s.div,t)&&l.setFlag(g.hasBackground),([...c.querySelectorAll("h1, h2, h3, h4, h5, h6")].length>0||["H1","H2","H3","H4","H5","H6"].includes(c.nodeName))&&l.setFlag(g.hasHeading),P(c,t)&&l.setFlag(g.hasCTA);let m=s.determineLayout();m.numRows>1&&l.setFlag(g.hasMultipleRows),m.numCols>1&&l.setFlag(g.hasMultipleColumns),m.numCols>1&&S.areBoxesLaidOutAsGrid(s.children)&&l.setFlag(g.isGridLayout),(c.closest("header, .header")||f.checkElStackUpCSSClasses(c,"header"))&&l.setFlag(g.isInsideAHeaderLikeElement),(c.closest("footer, .footer")||f.checkElStackUpCSSClasses(c,"footer"))&&l.setFlag(g.isInsideAFooterLikeElement)}let i=s.children;if(i.forEach((...a)=>{F(...a,t,!1)}),!o){let a=D.find(h=>h.predictFn(s,e,null,l,t));a&&(r=a.name)}if(i.length===0&&l.isFlagSet(g.isFromRootBox)&&e===0||i.length>0&&i.every(a=>a.prediction.sectionFeatures.includes("isInsideAHeaderLikeElement"))?r="header":i.length>0&&i.every(a=>a.prediction.sectionFeatures.includes("isInsideAFooterLikeElement"))&&(r="footer"),s.prediction=new T({sectionType:r,sectionFeatures:l.getFlags(g),confidence:-1}),console.group("prediction"),console.log("prediction"),console.log(l.getFlags(g)),console.log(c),console.log("section prediction:",s.prediction),console.groupEnd(),o){let a=function(p,v){return p.children.find(m=>m.prediction.sectionType===v?!0:a(m))},h=function(p,v){let m=p.children.slice(v)[0];return!m||m.children.length===0?p.div&&p.prediction.sectionType==="unknown"?p:m:h(m,v)};if(!a(s,"header")){let p=h(s,0);p&&(p.prediction=new T({sectionType:"header",sectionFeatures:p.prediction.sectionFeatures,confidence:-1}))}if(!a(s,"footer")){let p=h(s,-1);p&&(p.prediction=new T({sectionType:"footer",sectionFeatures:p.prediction.sectionFeatures,confidence:-1}))}}return s.prediction}function G(){let s=[...document.body.querySelectorAll("*")].filter(t=>!["IFRAME","NOSCRIPT","BR","EM","STRONG","STYLE","SCRIPT"].includes(t.nodeName)).reduce((t,o,r)=>{var l=o.closest("svg");return!(l!==null&&l!==o)&&!t.includes(o.nodeName)&&t.push(o.nodeName),t},[]);console.log("DOM node types:",s);let e=[...document.querySelectorAll(s.join(","))],n=d.filterDivs(e);return console.log(`found ${n.length} visible divs to show!`),n}d.getAllVisibleDivs=G;d.buildBoxTree=(s,e)=>{let n=new S(0,0,e.innerWidth,e.document.scrollingElement.scrollHeight),t=s.map(c=>S.fromDiv(c,e));function o(c,i,a){i.forEach((h,u)=>{if(a.has(u))return;if(c.contains(h,!1)){let p=h;c.addChild(p),a.add(u),o(p,i,a)}})}o(n,t,new Set);function r(c){c.determineLayout(),c.children.forEach(r)}r(n);function l(c){if(c.children.length===1&&c.layout.numCols===1){let i=c.children[0];c.children=i.children,l(c)}else c.children.forEach(l)}return l(n),r(n),n};d.getVerticalBoxesFromHierarchy=(s,e=!0)=>{let n={...s};function t(o){let r=o.children;if(r.some(c=>r.some(i=>c!==i&&!c.isInside(i)&&(c.x>=i.x+i.width||c.x+c.width<=i.x)))){o.setChildren([]);return}else for(let c=0;c<r.length;c++)t(r[c])}return t(n),n.children};d.boxes=null;d.selectElementToIgnore=()=>{document.body.style.cursor="crosshair",d.ui.overlaysDiv().addEventListener("click",e=>{let n=e.target;n.classList.contains("xp-overlay")&&n.remove(),d.ignoreElementForDection(n.dataset.boxId),document.body.style.removeProperty("cursor")},{once:!0})};d.ignoreElementForDection=s=>{function e(n){if(n.id===s){let t=function(o){[...d.ui.overlaysDiv().querySelectorAll(".xp-overlay")].forEach(l=>{l.dataset.boxId===o.id&&l.remove()}),o.children.forEach(t)};return n.ignored=!0,t(n),!0}else return n.children.some(e)}e(d.boxes)};d.predictPage=s=>{if(d.boxes?.children?.length>0){let n=function(o){o.ignored||(o.prediction&&o.prediction.sectionType!=="unknown"||o.prediction&&o.prediction.sectionType==="unknown"&&o.children.length===0?(e.push(o),console.warn(o.div,o.prediction),d.ui&&k(o,{window:s,padding:0,color:"rgba(0, 255, 0, 1)",label:o.prediction.sectionType})):o.children.forEach(n))};d.ui?.resetOverlays(),F(d.boxes,0,null,s);let e=[];n(d.boxes);let t=d.boxes.children.map(o=>{let r=[f.getXPath(o.div,document)];return r.push(...o.children.map(l=>"- "+f.getXPath(l.div,document))),r.join(`
`)||""}).join(`
`)||"";return d.boxes.template={raw:t,hash:E(t)},d.predictedBoxes=e,console.log("final boxes",d.boxes),console.log("predicted boxes",d.predictedBoxes),d.ui?.toggleOverlays(!0),d.boxes}};d.detectSections=async(s,e,n={autoDetect:!1})=>{d.ui?.resetOverlays();let{document:t}=e,o=f.getAllVisibleElements(s,e);console.log("visible divs",o),o=o.filter(i=>{let a=i.getBoundingClientRect();return a.width*a.height>3e4}),console.log("filtered divs",o);let r=d.buildBoxTree(o,e);console.log("boxes hierarchy",r);function l(i,a){i.div&&(i.xpath=f.getXPath(i.div,a),i.id=`box-id-${E(i.xpath)}`),i.children&&i.children.length>0&&i.children.forEach(h=>l(h,a))}l(r,t),d.boxes=r;let c=r.children.map(i=>{let a=[i.xpath];return a.push(...i.children.map(h=>"- "+h.xpath)),a.join(`
`)||""}).join(`
`)||"";if(console.log("template",c),d.template={raw:c,hash:E(c)},!n.autoDetect)B(r.children,e);else if(d.boxes?.children?.length>0){let a=function(u){u.ignored||(u.prediction&&u.prediction.sectionType!=="unknown"||u.prediction&&u.prediction.sectionType==="unknown"&&u.children.length===0?i.push(u):u.children.forEach(a))};F(d.boxes,0,null,e);let i=[];a(d.boxes),i.forEach(u=>{k(u,{window:e,target:e.document.body,padding:0,color:u.color,label:u.prediction.sectionType})});let h=d.boxes.children.map(u=>{let x=[f.getXPath(u.div,t)];return x.push(...u.children.map(p=>"- "+f.getXPath(p.div,t))),x.join(`
`)||""}).join(`
`)||"";d.boxes.template={raw:h,hash:E(h)},d.boxes.predictedBoxes=i,console.log("final boxes",d.boxes),d.ui?.toggleOverlays(!0)}return d.ui?.toggleOverlays(!0),d.boxes};window.xp=d;})();
